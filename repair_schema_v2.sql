-- ==========================================
-- REPAIR SCRIPT v2: Fix type mismatch
-- ==========================================

-- 1. Program Plans Table
-- DROP to ensure we recreate with correct types (Safety: No important data there yet as saving failed)
DROP TABLE IF EXISTS public.program_plans;

create table public.program_plans (
  id uuid default gen_random_uuid() primary key,
  -- Changed to TEXT to match programs.id which seems to be TEXT
  program_id text references public.programs(id) on delete cascade not null,
  name text not null,
  price numeric not null,
  deadline date,
  status text check (status in ('active', 'hidden', 'sold_out')) default 'active',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. Programs Table Columns (Ensure they exist)
-- We assume programs table exists (referenced by FK above)
alter table public.programs 
add column if not exists internal_id text unique,
add column if not exists image text,
add column if not exists itinerary jsonb default '[]'::jsonb,
add column if not exists flights jsonb default '[]'::jsonb,
add column if not exists inclusions text[] default '{}',
add column if not exists created_at timestamp with time zone default timezone('utc'::text, now()) not null,
add column if not exists updated_at timestamp with time zone default timezone('utc'::text, now()) not null;

-- 2b. Prospects Table Updates
-- Ensure prospects table has birth_date
create table if not exists public.prospects (
  id uuid default gen_random_uuid() primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  name text,
  email text,
  phone text,
  interest text,
  message text,
  source text,
  status text default 'new',
  notes jsonb
);

alter table public.prospects 
add column if not exists birth_date date;


-- 2c. Folio Logic (Sequential P1001, P1002...)
-- We add an auto-incrementing number and a generated text column
alter table public.prospects 
add column if not exists folio_number bigint generated by default as identity (start with 1001),
add column if not exists folio text generated always as ('P' || folio_number::text) stored,
add column if not exists form_id text;

-- Ensure RLS is enabled for Prospects
alter table public.prospects enable row level security;

-- Policies for Prospects (if they don't exist, we use DO block or just try create and ignore error if dupes? 
-- Simplest is to drop and recreate policy or use 'create policy if not exists' (pg16+) 
-- or just rely on the user running this once. I'll use standard create, user ignores if error "policy already exists")
-- Public can insert (Form Submissions)
drop policy if exists "Public can create prospects" on public.prospects;
create policy "Public can create prospects" on public.prospects for insert with check (true);

-- Staff can view/update
drop policy if exists "Staff can view and update prospects" on public.prospects;
create policy "Staff can view and update prospects" on public.prospects
  for all using (
    exists (
      select 1 from public.profiles
      where id = auth.uid() and role = 'staff'
    )
  );

-- 3. Enable RLS on program_plans
alter table public.program_plans enable row level security;

-- 4. RLS Policies
drop policy if exists "Public can view active plans" on public.program_plans;
create policy "Public can view active plans" on public.program_plans
  for select using (status = 'active');

drop policy if exists "Staff can manage plans" on public.program_plans;
create policy "Staff can manage plans" on public.program_plans
  for all using (
    exists (
      select 1 from public.profiles
      where id = auth.uid() and role = 'staff'
    )
  );

-- 5. Contact Messages (New table for general inquiries)
create table if not exists public.contact_messages (
  id uuid default gen_random_uuid() primary key,
  name text not null,
  email text not null,
  interest text,
  message text,
  status text check (status in ('new', 'read', 'archived')) default 'new',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Enable RLS
alter table public.contact_messages enable row level security;

-- Policies
drop policy if exists "Public can create contact messages" on public.contact_messages;
create policy "Public can create contact messages" on public.contact_messages
  for insert with check (true);
  
drop policy if exists "Staff can view contact messages" on public.contact_messages;
create policy "Staff can view contact messages" on public.contact_messages
  for select using (
    exists (
      select 1 from public.profiles
      where id = auth.uid() and role = 'staff'
    )
  );

-- 6. Reload Schema
NOTIFY pgrst, 'reload config';
